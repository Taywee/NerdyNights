<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>&lt;no title&gt; &mdash; Nerdy Nights 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Nerdy Nights 1.0.0 documentation" href="../index.html" />
    <link rel="up" title="Nerdy Nights" href="../nerdynights.html" />
    <link rel="next" title="&lt;no title&gt;" href="numbers.html" />
    <link rel="prev" title="&lt;no title&gt;" href="subroutines.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="numbers.html" title="&lt;no title&gt;"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="subroutines.html" title="&lt;no title&gt;"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Nerdy Nights 1.0.0 documentation</a> &raquo;</li>
          <li><a href="../nerdynights.html" accesskey="U">Nerdy Nights</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div><p><strong>This Week:</strong> The NES is an 8 bit machine, but sometimes you need more!
Learn to handle 16+ bit numbers, and use them for bigger loops.</p>
<blockquote>
<div><strong>16 Bit Math</strong>
Doing 16 bit addition and subtraction is fairly simple because of the</div></blockquote>
<p>carry flag that we had previously been clearing. First the normal add is
done using the clc/adc pair. This add is for the lower 8 bits of the 16
bit number. For the upper 8 bits the adc instruction is used again, but
without the clc. You want to keep the carry from the first add, in case
it overflowed. To only add in the carry the second adc value is just 0.</p>
<blockquote>
<div>Here are some examples in decimal. One digit column is added at a time.</div></blockquote>
<p>The carry (1) is added to the next column as needed.</p>
<div class="highlight-asm"><div class="highlight"><pre><span></span>    0 3
+   0 4
    0 7  (no carry needed, top digit = 0)
</pre></div>
</div>
<div class="highlight-asm"><div class="highlight"><pre><span></span>    0 4
+   0 8
    1 2  (carry only, top digit = 1)
</pre></div>
</div>
<div class="highlight-asm"><div class="highlight"><pre><span></span>       2 2
   +   1 9
       4 1  (carry plus 2 plus 1, top digit = 4)

And the code to do it on the NES, adding 1 to a 16 bit number:
</pre></div>
</div>
<div class="highlight-asm"><div class="highlight"><pre><span></span>     LDA lowbyte      ; load low 8 bits of 16 bit value
     CLC              ; clear carry
     ADC #$01         ; add 1
     STA lowbyte      ; done with low bits, save back
     LDA highbyte     ; load upper 8 bits
     ADC #$00         ; add 0 and carry from previous add
     STA highbyte     ; save back

The same process of adding 0 without clearing the carry can be
</pre></div>
</div>
<p>continued to do 24 bit, 32 bit, or higher numbers. It is also the same
process to do 16 bit subtraction:</p>
<div class="highlight-asm"><div class="highlight"><pre><span></span>     LDA lowbyte      ; load low 8 bits of 16 bit value
     SEC              ; set carry
     SBC #$01         ; subtract 1
     STA lowbyte      ; done with low bits, save back
     LDA highbyte     ; load upper 8 bits
     SBC #$00         ; subtract 0 and carry from previous sub
     STA highbyte     ; save back

**Pointers and Indirect Indexed Mode**
Previously when loading background tiles the x register was used as an
</pre></div>
</div>
<p>8 bit offset. Now that we can handle 16 bit numbers a different
addressing mode can be used. The 16 bit address is saved into two 8 bit
variables, which are then used as a &#8220;<strong>pointer</strong>&#8221; which points to the
background data we want. The LDA instruction then uses the &#8220;<strong>Indirect
Indexed</strong>&#8221; addressing mode. This takes the 16 bit variable inside the
brackets and uses it as an address. For the address to be correct, the
low byte must be first and the high byte must come immediately after.
Then the value in the Y register is added to the address. This forms the
final address to load from. Both variables must also be in the first 256
bytes of RAM, called &#8220;<strong>Zero Page</strong>&#8221;, and the X register cannot be
used with this addressing mode.</p>
<div class="highlight-asm"><div class="highlight"><pre><span></span>  .rsset $0000       ; put pointers in zero page
pointerLo  .rs 1   ; pointer variables are declared in RAM
pointerHi  .rs 1   ; low byte first, high byte immediately after
</pre></div>
</div>
<div class="highlight-asm"><div class="highlight"><pre><span></span>LDA #$D0
STA pointerHi
LDA #$12
STA pointerLo       ; pointer now says $D012
</pre></div>
</div>
<div class="highlight-asm"><div class="highlight"><pre><span></span>     LDY #$00            ; no offset from Y
     LDA [pointerLo], y  ; load data from the address pointed to by the 16 bit pointer variable plus the value in the Y register

That last line is the same as
</pre></div>
</div>
<div class="highlight-asm"><div class="highlight"><pre><span></span><span class="nf">LDA</span> <span class="no">$D012</span><span class="p">,</span> <span class="no">y</span>
</pre></div>
</div>
<p>Because we kept Y = 0, that is the same as</p>
<div class="highlight-asm"><div class="highlight"><pre><span></span><span class="nf">LDA</span> <span class="no">$D012</span>
</pre></div>
</div>
<dl class="docutils">
<dt>** Copy Loops **</dt>
<dd>Now using your 16 bit math the pointer address can be incremented.</dd>
</dl>
<p>Instead of being limited to 256 background tiles like when using the x
offset, the whole background can be copied in one loop. First the
address of the background data is put into the pointer variable. The
high and low bytes of the address are each copied individually. Then the
number of tiles to copy is put into the loop counter, which will count
down to 0. Each time through the loop one byte will be copied, the 16
bit pointer address will be incremented, and the 16 bit loop counter
will be decremented. The Y offset is always kept at 0, because the
pointer always points to the correct byte. When the loop counter reaches
0 everything is done.</p>
<div class="highlight-asm"><div class="highlight"><pre><span></span>LDA #LOW(background)
STA pointerLo       ; put the low byte of the address of background into pointer
LDA #HIGH(background)
STA pointerHi       ; put the high byte of the address into pointer
</pre></div>
</div>
<div class="highlight-asm"><div class="highlight"><pre><span></span>LDA #$00
sta counterLo       ; put the loop counter into 16 bit variable
LDA #$04
sta counterHi       ; count = $0400 = 1KB, the whole screen at once including attributes
</pre></div>
</div>
<div class="highlight-asm"><div class="highlight"><pre><span></span>  LDY #$00            ; put y to 0 and don&#39;t change it
LoadBackgroundLoop:
  LDA [pointerLo], y
  STA $2007           ; copy one background byte
</pre></div>
</div>
<div class="highlight-asm"><div class="highlight"><pre><span></span>LDA pointerLo
CLC
ADC #$01
STA pointerLo
LDA pointerHi
ADC #$00
STA pointerHi       ; increment the pointer to the next byte
</pre></div>
</div>
<div class="highlight-asm"><div class="highlight"><pre><span></span>LDA counterLo
SEC
SBC #$01
STA counterLo
LDA counterHi
SBC #$00
STA counterHi       ; decrement the loop counter
</pre></div>
</div>
<div class="highlight-asm"><div class="highlight"><pre><span></span>LDA counterLo
CMP #$00
BNE LoadBackgroundLoop
LDA counterHi
CMP #$00
BNE LoadBackgroundLoop  ; if the loop counter isn&#39;t 0000, keep copying
</pre></div>
</div>
<dl class="docutils">
<dt>That is a lot of code to copy just one byte!</dt>
<dd><strong>Nested Loops</strong>
To avoid using so much code, we can use both the X and Y registers as</dd>
</dl>
<p>loop counters. By putting one loop inside another loop we create a
&#8220;nested loop&#8221;. First the inside loop counts all the way up. Then the
outside loop counts up once, and the inside loop counts all the way
again. Normally using only X or Y would only give a maximum of 256 times
through a loop like we have previously done. With nested loops using
both X and Y the maximum is the inside counter multiplied by the outside
counter, or 256*256 = 65536.</p>
<div class="highlight-asm"><div class="highlight"><pre><span></span>  LDX #$00
  LDY #$00
OutsideLoop:

InsideLoop:
  ;
  ; this section runs 256 x 256 times
  ;

  INY                 ; inside loop counter
  CPY #$00
  BNE InsideLoop      ; run the inside loop 256 times before continuing down

  INX
  CPX #$00
  BNE OutsideLoop     ; run the outside loop 256 times before continuing down
</pre></div>
</div>
<div></div><p>First the Inside Loop runs and Y will count from 0 to 256. When that
finishes X will count 0 to 1, and branch back to the beginning of the
loops. Then the Inside Loop runs again, Y 0 -&gt; 256. X now goes 1 -&gt; 2
and the process continues. Everything ends when both X and Y have each
counted to 256.</p>
<blockquote>
<div>When we are using nested loops to copy entire backgrounds we want 256 x</div></blockquote>
<p>4 = 1KB. The Y code from above can be unchanged, but the X code is
changed to CPX #$04.</p>
<blockquote>
<div>Because we are changing the Y register our previous pointer copying</div></blockquote>
<p>code also needs to be modified. Instead of incrementing the pointer
every time, the incrementing Y register is doing the same thing. The low
byte of the pointer will be kept at 0. This means your background data
needs to be aligned to where the low byte of the address is $00. However
the high byte of the pointer still needs to change. By always making the
inside loop count 256 times, that will end at the same time that the
high byte needs to change. This time 16 bit math isn&#8217;t needed because
only the high byte is incremented.</p>
<blockquote>
<div>No loop counter is used because X and Y are used instead. If you cannot</div></blockquote>
<p>align your data so the low byte of the address is $00, you will have to
use the CopyLoop above.</p>
<div class="highlight-asm"><div class="highlight"><pre><span></span>     LDA #$00
     STA pointerLo       ; put the low byte of the address of background into pointer
     LDA #HIGH(background)
     STA pointerHi       ; put the high byte of the address into pointer

     LDX #$00            ; start at pointer + 0
     LDY #$00
   OutsideLoop:

   InsideLoop:
     LDA [pointerLo], y  ; copy one background byte from address in pointer plus Y
     STA $2007           ; this runs 256 * 4 times

     INY                 ; inside loop counter
     CPY #$00
     BNE InsideLoop      ; run the inside loop 256 times before continuing down

     INC pointerHi       ; low byte went 0 to 256, so high byte needs to be changed now

     INX
     CPX #$04
     BNE OutsideLoop     ; run the outside loop 256 times before continuing down

**Putting It All Together**
Download and unzip the
</pre></div>
</div>
<p><a class="reference external" href="http://www.nespowerpak.com/nesasm/background3.zip">background3.zip</a>
sample files. All the code is in the background.asm file. Make sure that
file, mario.chr, and background.bat is in the same folder as NESASM,
then double click on background.bat. That will run NESASM and should
produce background3.nes. Run that NES file in FCEUXD SP to see the full
background.</p>
<blockquote>
<div>The new nested loop is used to copy a whole background to the screen</div></blockquote>
<p>instead of only 128 bytes. &nbsp;The background is aligned using the .org
directive so the low address byte is $00. &nbsp;The attributes are also
placed directly after the background data so it is are copied at the
same time.</p>
<div></div><div><p>Your task is to separate out the code that sets the pointer variables
from the code that copies the loop. That way you can have multiple
backgrounds that use different pointer loading code, but the same copy
code.</p>
<blockquote>
<div>If you are using a different assembler, the Indirect Indexed mode may</div></blockquote>
<p>use () instead of []. The LOW() and HIGH() syntax may also be different.</p>
</div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="subroutines.html"
                        title="previous chapter">&lt;no title&gt;</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="numbers.html"
                        title="next chapter">&lt;no title&gt;</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/nerdynights/bitmath.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="numbers.html" title="&lt;no title&gt;"
             >next</a> |</li>
        <li class="right" >
          <a href="subroutines.html" title="&lt;no title&gt;"
             >previous</a> |</li>
        <li><a href="../index.html">Nerdy Nights 1.0.0 documentation</a> &raquo;</li>
          <li><a href="../nerdynights.html" >Nerdy Nights</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2017, bunnyboy, MetalSlime, Taywee.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>