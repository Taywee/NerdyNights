<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>8. 16 bit math, pointers, nested loops &#8212; Nerdy Nights 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9. Numbers, Bin to Dec" href="numbers.html" />
    <link rel="prev" title="7. subroutines, game layout, starting Pong" href="subroutines.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="bit-math-pointers-nested-loops">
<h1>8. 16 bit math, pointers, nested loops<a class="headerlink" href="#bit-math-pointers-nested-loops" title="Permalink to this headline">¶</a></h1>
<div class="admonition-this-week admonition">
<p class="first admonition-title">This Week</p>
<p class="last">The NES is an 8 bit machine, but sometimes you need more!  Learn to handle
16+ bit numbers, and use them for bigger loops.</p>
</div>
<div class="section" id="bit-math">
<h2>8.1. 16 Bit Math<a class="headerlink" href="#bit-math" title="Permalink to this headline">¶</a></h2>
<p>Doing 16 bit addition and subtraction is fairly simple because of the carry
flag that we had previously been clearing. First the normal add is done using
the clc/adc pair. This add is for the lower 8 bits of the 16 bit number. For
the upper 8 bits the adc instruction is used again, but without the clc. You
want to keep the carry from the first add, in case it overflowed. To only add
in the carry the second adc value is just 0.</p>
<p>Here are some examples in decimal. One digit column is added at a time.  The
carry (1) is added to the next column as needed.</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>  <span class="mi">0</span> <span class="mi">3</span>
<span class="o">+</span> <span class="mi">0</span> <span class="mi">4</span>
  <span class="mi">0</span> <span class="mi">7</span>  <span class="p">(</span><span class="n">no</span> <span class="n">carry</span> <span class="n">needed</span><span class="p">,</span> <span class="n">top</span> <span class="n">digit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>  <span class="mi">0</span> <span class="mi">4</span>
<span class="o">+</span> <span class="mi">0</span> <span class="mi">8</span>
  <span class="mi">1</span> <span class="mi">2</span>  <span class="p">(</span><span class="n">carry</span> <span class="n">only</span><span class="p">,</span> <span class="n">top</span> <span class="n">digit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>  <span class="mi">2</span> <span class="mi">2</span>
<span class="o">+</span> <span class="mi">1</span> <span class="mi">9</span>
  <span class="mi">4</span> <span class="mi">1</span>  <span class="p">(</span><span class="n">carry</span> <span class="n">plus</span> <span class="mi">2</span> <span class="n">plus</span> <span class="mi">1</span><span class="p">,</span> <span class="n">top</span> <span class="n">digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>And the code to do it on the NES, adding 1 to a 16 bit number:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="n">lowbyte</span>      <span class="c1">; load low 8 bits of 16 bit value</span>
<span class="k">CLC</span>              <span class="c1">; clear carry</span>
<span class="k">ADC</span> <span class="p">#</span><span class="mh">$01</span>         <span class="c1">; add 1</span>
<span class="k">STA</span> <span class="n">lowbyte</span>      <span class="c1">; done with low bits, save back</span>
<span class="k">LDA</span> <span class="n">highbyte</span>     <span class="c1">; load upper 8 bits</span>
<span class="k">ADC</span> <span class="p">#</span><span class="mh">$00</span>         <span class="c1">; add 0 and carry from previous add</span>
<span class="k">STA</span> <span class="n">highbyte</span>     <span class="c1">; save back</span>
</pre></div>
</div>
<p>The same process of adding 0 without clearing the carry can be continued to do
24 bit, 32 bit, or higher numbers. It is also the same process to do 16 bit
subtraction:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="n">lowbyte</span>      <span class="c1">; load low 8 bits of 16 bit value</span>
<span class="k">SEC</span>              <span class="c1">; set carry</span>
<span class="k">SBC</span> <span class="p">#</span><span class="mh">$01</span>         <span class="c1">; subtract 1</span>
<span class="k">STA</span> <span class="n">lowbyte</span>      <span class="c1">; done with low bits, save back</span>
<span class="k">LDA</span> <span class="n">highbyte</span>     <span class="c1">; load upper 8 bits</span>
<span class="k">SBC</span> <span class="p">#</span><span class="mh">$00</span>         <span class="c1">; subtract 0 and carry from previous sub</span>
<span class="k">STA</span> <span class="n">highbyte</span>     <span class="c1">; save back</span>
</pre></div>
</div>
</div>
<div class="section" id="pointers-and-indirect-indexed-mode">
<h2>8.2. Pointers and Indirect Indexed Mode<a class="headerlink" href="#pointers-and-indirect-indexed-mode" title="Permalink to this headline">¶</a></h2>
<p>Previously when loading background tiles the x register was used as an 8 bit
offset. Now that we can handle 16 bit numbers a different addressing mode can
be used. The 16 bit address is saved into two 8 bit variables, which are then
used as a <strong>pointer</strong> which points to the background data we want. The LDA
instruction then uses the <strong>Indirect Indexed</strong> addressing mode. This takes the
16 bit variable inside the brackets and uses it as an address. For the address
to be correct, the low byte must be first and the high byte must come
immediately after.  Then the value in the Y register is added to the address.
This forms the final address to load from. Both variables must also be in the
first 256 bytes of RAM, called <strong>Zero Page</strong>, and the X register cannot be used
with this addressing mode:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>  <span class="kp">.rsset</span> <span class="mh">$0000</span>       <span class="c1">; put pointers in zero page</span>
<span class="n">pointerLo</span>  <span class="kp">.rs</span> <span class="mi">1</span>   <span class="c1">; pointer variables are declared in RAM</span>
<span class="n">pointerHi</span>  <span class="kp">.rs</span> <span class="mi">1</span>   <span class="c1">; low byte first, high byte immediately after</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="p">#</span><span class="mh">$D0</span>
<span class="k">STA</span> <span class="n">pointerHi</span>
<span class="k">LDA</span> <span class="p">#</span><span class="mh">$12</span>
<span class="k">STA</span> <span class="n">pointerLo</span>       <span class="c1">; pointer now says $D012</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDY</span> <span class="p">#</span><span class="mh">$00</span>            <span class="c1">; no offset from Y</span>
<span class="k">LDA</span> <span class="p">[</span><span class="n">pointerLo</span><span class="p">],</span> <span class="n">y</span>  <span class="c1">; load data from the address pointed to by the 16 bit pointer variable plus the value in the Y register</span>
</pre></div>
</div>
<p>That last line is the same as:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="mh">$D012</span><span class="p">,</span> <span class="n">y</span>
</pre></div>
</div>
<p>Because we kept Y = 0, that is the same as:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="mh">$D012</span>
</pre></div>
</div>
</div>
<div class="section" id="copy-loops">
<h2>8.3. Copy Loops<a class="headerlink" href="#copy-loops" title="Permalink to this headline">¶</a></h2>
<p>Now using your 16 bit math the pointer address can be incremented.  Instead of
being limited to 256 background tiles like when using the x offset, the whole
background can be copied in one loop. First the address of the background data
is put into the pointer variable. The high and low bytes of the address are
each copied individually. Then the number of tiles to copy is put into the loop
counter, which will count down to 0. Each time through the loop one byte will
be copied, the 16 bit pointer address will be incremented, and the 16 bit loop
counter will be decremented. The Y offset is always kept at 0, because the
pointer always points to the correct byte. When the loop counter reaches 0
everything is done:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="p">#</span><span class="n">LOW</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>
<span class="k">STA</span> <span class="n">pointerLo</span>       <span class="c1">; put the low byte of the address of background into pointer</span>
<span class="k">LDA</span> <span class="p">#</span><span class="n">HIGH</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>
<span class="k">STA</span> <span class="n">pointerHi</span>       <span class="c1">; put the high byte of the address into pointer</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">sta</span> <span class="n">counterLo</span>       <span class="c1">; put the loop counter into 16 bit variable</span>
<span class="k">LDA</span> <span class="p">#</span><span class="mh">$04</span>
<span class="k">sta</span> <span class="n">counterHi</span>       <span class="c1">; count = $0400 = 1KB, the whole screen at once including attributes</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>  <span class="k">LDY</span> <span class="p">#</span><span class="mh">$00</span>            <span class="c1">; put y to 0 and don&#39;t change it</span>
<span class="nl">LoadBackgroundLoop:</span>
  <span class="k">LDA</span> <span class="p">[</span><span class="n">pointerLo</span><span class="p">],</span> <span class="n">y</span>
  <span class="k">STA</span> <span class="mh">$2007</span>           <span class="c1">; copy one background byte</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="n">pointerLo</span>
<span class="k">CLC</span>
<span class="k">ADC</span> <span class="p">#</span><span class="mh">$01</span>
<span class="k">STA</span> <span class="n">pointerLo</span>
<span class="k">LDA</span> <span class="n">pointerHi</span>
<span class="k">ADC</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">STA</span> <span class="n">pointerHi</span>       <span class="c1">; increment the pointer to the next byte</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="n">counterLo</span>
<span class="k">SEC</span>
<span class="k">SBC</span> <span class="p">#</span><span class="mh">$01</span>
<span class="k">STA</span> <span class="n">counterLo</span>
<span class="k">LDA</span> <span class="n">counterHi</span>
<span class="k">SBC</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">STA</span> <span class="n">counterHi</span>       <span class="c1">; decrement the loop counter</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="n">counterLo</span>
<span class="k">CMP</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">BNE</span> <span class="n">LoadBackgroundLoop</span>
<span class="k">LDA</span> <span class="n">counterHi</span>
<span class="k">CMP</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">BNE</span> <span class="n">LoadBackgroundLoop</span>  <span class="c1">; if the loop counter isn&#39;t 0000, keep copying</span>
</pre></div>
</div>
<p>That is a lot of code to copy just one byte!</p>
</div>
<div class="section" id="nested-loops">
<h2>8.4. Nested Loops<a class="headerlink" href="#nested-loops" title="Permalink to this headline">¶</a></h2>
<p>To avoid using so much code, we can use both the X and Y registers as loop
counters. By putting one loop inside another loop we create a &#8220;nested loop&#8221;.
First the inside loop counts all the way up. Then the outside loop counts up
once, and the inside loop counts all the way again. Normally using only X or Y
would only give a maximum of 256 times through a loop like we have previously
done. With nested loops using both X and Y the maximum is the inside counter
multiplied by the outside counter, or 256*256 = 65536:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>  <span class="k">LDX</span> <span class="p">#</span><span class="mh">$00</span>
  <span class="k">LDY</span> <span class="p">#</span><span class="mh">$00</span>
<span class="nl">OutsideLoop:</span>

<span class="nl">InsideLoop:</span>
  <span class="c1">;</span>
  <span class="c1">; this section runs 256 x 256 times</span>
  <span class="c1">;</span>

  <span class="k">INY</span>                 <span class="c1">; inside loop counter</span>
  <span class="k">CPY</span> <span class="p">#</span><span class="mh">$00</span>
  <span class="k">BNE</span> <span class="n">InsideLoop</span>      <span class="c1">; run the inside loop 256 times before continuing down</span>

  <span class="k">INX</span>
  <span class="k">CPX</span> <span class="p">#</span><span class="mh">$00</span>
  <span class="k">BNE</span> <span class="n">OutsideLoop</span>     <span class="c1">; run the outside loop 256 times before continuing down</span>
</pre></div>
</div>
<p>First the Inside Loop runs and Y will count from 0 to 256. When that finishes X
will count 0 to 1, and branch back to the beginning of the loops. Then the
Inside Loop runs again, Y 0 -&gt; 256. X now goes 1 -&gt; 2 and the process
continues. Everything ends when both X and Y have each counted to 256.</p>
<p>When we are using nested loops to copy entire backgrounds we want 256 x 4 =
1KB. The Y code from above can be unchanged, but the X code is changed to CPX
#$04.</p>
<p>Because we are changing the Y register our previous pointer copying code also
needs to be modified. Instead of incrementing the pointer every time, the
incrementing Y register is doing the same thing. The low byte of the pointer
will be kept at 0. This means your background data needs to be aligned to where
the low byte of the address is $00. However the high byte of the pointer still
needs to change. By always making the inside loop count 256 times, that will
end at the same time that the high byte needs to change. This time 16 bit math
isn&#8217;t needed because only the high byte is incremented.</p>
<p>No loop counter is used because X and Y are used instead. If you cannot align
your data so the low byte of the address is $00, you will have to use the
CopyLoop above:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>  <span class="k">LDA</span> <span class="p">#</span><span class="mh">$00</span>
  <span class="k">STA</span> <span class="n">pointerLo</span>       <span class="c1">; put the low byte of the address of background into pointer</span>
  <span class="k">LDA</span> <span class="p">#</span><span class="n">HIGH</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>
  <span class="k">STA</span> <span class="n">pointerHi</span>       <span class="c1">; put the high byte of the address into pointer</span>

  <span class="k">LDX</span> <span class="p">#</span><span class="mh">$00</span>            <span class="c1">; start at pointer + 0</span>
  <span class="k">LDY</span> <span class="p">#</span><span class="mh">$00</span>
<span class="nl">OutsideLoop:</span>

<span class="nl">InsideLoop:</span>
  <span class="k">LDA</span> <span class="p">[</span><span class="n">pointerLo</span><span class="p">],</span> <span class="n">y</span>  <span class="c1">; copy one background byte from address in pointer plus Y</span>
  <span class="k">STA</span> <span class="mh">$2007</span>           <span class="c1">; this runs 256 * 4 times</span>

  <span class="k">INY</span>                 <span class="c1">; inside loop counter</span>
  <span class="k">CPY</span> <span class="p">#</span><span class="mh">$00</span>
  <span class="k">BNE</span> <span class="n">InsideLoop</span>      <span class="c1">; run the inside loop 256 times before continuing down</span>

  <span class="k">INC</span> <span class="n">pointerHi</span>       <span class="c1">; low byte went 0 to 256, so high byte needs to be changed now</span>

  <span class="k">INX</span>
  <span class="k">CPX</span> <span class="p">#</span><span class="mh">$04</span>
  <span class="k">BNE</span> <span class="n">OutsideLoop</span>     <span class="c1">; run the outside loop 256 times before continuing down</span>
</pre></div>
</div>
</div>
<div class="section" id="putting-it-all-together">
<h2>8.5. Putting It All Together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this headline">¶</a></h2>
<p>Download and unzip the <a class="reference download internal" href="../_downloads/background3.zip" download=""><code class="xref download docutils literal"><span class="pre">background3.zip</span></code></a>
sample files. All the code is in the background.asm file. Make sure that file,
mario.chr, and background.bat is in the same folder as NESASM, then double
click on background.bat. That will run NESASM and should produce
background3.nes. Run that NES file in FCEUXD SP to see the full background.</p>
<p>The new nested loop is used to copy a whole background to the screen instead of
only 128 bytes. &nbsp;The background is aligned using the .org directive so the low
address byte is $00. &nbsp;The attributes are also placed directly after the
background data so it is are copied at the same time.</p>
<p>Your task is to separate out the code that sets the pointer variables from the
code that copies the loop. That way you can have multiple backgrounds that use
different pointer loading code, but the same copy code.</p>
<p>If you are using a different assembler, the Indirect Indexed mode may use ()
instead of []. The LOW() and HIGH() syntax may also be different.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">8. 16 bit math, pointers, nested loops</a><ul>
<li><a class="reference internal" href="#bit-math">8.1. 16 Bit Math</a></li>
<li><a class="reference internal" href="#pointers-and-indirect-indexed-mode">8.2. Pointers and Indirect Indexed Mode</a></li>
<li><a class="reference internal" href="#copy-loops">8.3. Copy Loops</a></li>
<li><a class="reference internal" href="#nested-loops">8.4. Nested Loops</a></li>
<li><a class="reference internal" href="#putting-it-all-together">8.5. Putting It All Together</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../nerdynights.html">Nerdy Nights</a><ul>
      <li>Previous: <a href="subroutines.html" title="previous chapter">7. subroutines, game layout, starting Pong</a></li>
      <li>Next: <a href="numbers.html" title="next chapter">9. Numbers, Bin to Dec</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/nerdynights/bitmath.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, bunnyboy, MetalSlime, Taywee.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="../_sources/nerdynights/bitmath.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>