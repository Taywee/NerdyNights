<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>&lt;no title&gt; &mdash; Nerdy Nights 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Nerdy Nights 1.0.0 documentation" href="../index.html" />
    <link rel="up" title="Nerdy Nights" href="../nerdynights.html" />
    <link rel="next" title="&lt;no title&gt;" href="numbers.html" />
    <link rel="prev" title="7. subroutines, game layout, starting Pong" href="subroutines.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="numbers.html" title="&lt;no title&gt;"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="subroutines.html" title="7. subroutines, game layout, starting Pong"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Nerdy Nights 1.0.0 documentation</a> &raquo;</li>
          <li><a href="../nerdynights.html" accesskey="U">Nerdy Nights</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div><p><strong>This Week:</strong> The NES is an 8 bit machine, but sometimes you need more!
Learn to handle 16+ bit numbers, and use them for bigger loops.</p>
<blockquote>
<div><strong>16 Bit Math</strong>
Doing 16 bit addition and subtraction is fairly simple because of the</div></blockquote>
<p>carry flag that we had previously been clearing. First the normal add is
done using the clc/adc pair. This add is for the lower 8 bits of the 16
bit number. For the upper 8 bits the adc instruction is used again, but
without the clc. You want to keep the carry from the first add, in case
it overflowed. To only add in the carry the second adc value is just 0.</p>
<blockquote>
<div>Here are some examples in decimal. One digit column is added at a time.</div></blockquote>
<p>The carry (1) is added to the next column as needed.</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>    <span class="mi">0</span> <span class="mi">3</span>
<span class="o">+</span>   <span class="mi">0</span> <span class="mi">4</span>
    <span class="mi">0</span> <span class="mi">7</span>  <span class="p">(</span><span class="n">no</span> <span class="n">carry</span> <span class="n">needed</span><span class="p">,</span> <span class="n">top</span> <span class="n">digit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>    <span class="mi">0</span> <span class="mi">4</span>
<span class="o">+</span>   <span class="mi">0</span> <span class="mi">8</span>
    <span class="mi">1</span> <span class="mi">2</span>  <span class="p">(</span><span class="n">carry</span> <span class="n">only</span><span class="p">,</span> <span class="n">top</span> <span class="n">digit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>       <span class="mi">2</span> <span class="mi">2</span>
   <span class="o">+</span>   <span class="mi">1</span> <span class="mi">9</span>
       <span class="mi">4</span> <span class="mi">1</span>  <span class="p">(</span><span class="n">carry</span> <span class="n">plus</span> <span class="mi">2</span> <span class="n">plus</span> <span class="mi">1</span><span class="p">,</span> <span class="n">top</span> <span class="n">digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>

<span class="k">And</span> <span class="n">the</span> <span class="n">code</span> <span class="n">to</span> <span class="n">do</span> <span class="n">it</span> <span class="n">on</span> <span class="n">the</span> <span class="n">NES</span><span class="p">,</span> <span class="n">adding</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">a</span> <span class="mi">16</span> <span class="k">bit</span> <span class="nl">number:</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>     <span class="k">LDA</span> <span class="n">lowbyte</span>      <span class="c1">; load low 8 bits of 16 bit value</span>
     <span class="k">CLC</span>              <span class="c1">; clear carry</span>
     <span class="k">ADC</span> <span class="p">#</span><span class="mh">$01</span>         <span class="c1">; add 1</span>
     <span class="k">STA</span> <span class="n">lowbyte</span>      <span class="c1">; done with low bits, save back</span>
     <span class="k">LDA</span> <span class="n">highbyte</span>     <span class="c1">; load upper 8 bits</span>
     <span class="k">ADC</span> <span class="p">#</span><span class="mh">$00</span>         <span class="c1">; add 0 and carry from previous add</span>
     <span class="k">STA</span> <span class="n">highbyte</span>     <span class="c1">; save back</span>

<span class="n">The</span> <span class="n">same</span> <span class="n">process</span> <span class="n">of</span> <span class="n">adding</span> <span class="mi">0</span> <span class="n">without</span> <span class="n">clearing</span> <span class="n">the</span> <span class="n">carry</span> <span class="n">can</span> <span class="n">be</span>
</pre></div>
</div>
<p>continued to do 24 bit, 32 bit, or higher numbers. It is also the same
process to do 16 bit subtraction:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>     <span class="k">LDA</span> <span class="n">lowbyte</span>      <span class="c1">; load low 8 bits of 16 bit value</span>
     <span class="k">SEC</span>              <span class="c1">; set carry</span>
     <span class="k">SBC</span> <span class="p">#</span><span class="mh">$01</span>         <span class="c1">; subtract 1</span>
     <span class="k">STA</span> <span class="n">lowbyte</span>      <span class="c1">; done with low bits, save back</span>
     <span class="k">LDA</span> <span class="n">highbyte</span>     <span class="c1">; load upper 8 bits</span>
     <span class="k">SBC</span> <span class="p">#</span><span class="mh">$00</span>         <span class="c1">; subtract 0 and carry from previous sub</span>
     <span class="k">STA</span> <span class="n">highbyte</span>     <span class="c1">; save back</span>

<span class="o">**</span><span class="n">Pointers</span> <span class="k">and</span> <span class="n">Indirect</span> <span class="n">Indexed</span> <span class="n">Mode</span><span class="o">**</span>
<span class="n">Previously</span> <span class="n">when</span> <span class="n">loading</span> <span class="n">background</span> <span class="n">tiles</span> <span class="n">the</span> <span class="n">x</span> <span class="n">register</span> <span class="n">was</span> <span class="n">used</span> <span class="n">as</span> <span class="n">an</span>
</pre></div>
</div>
<p>8 bit offset. Now that we can handle 16 bit numbers a different
addressing mode can be used. The 16 bit address is saved into two 8 bit
variables, which are then used as a &#8220;<strong>pointer</strong>&#8221; which points to the
background data we want. The LDA instruction then uses the &#8220;<strong>Indirect
Indexed</strong>&#8221; addressing mode. This takes the 16 bit variable inside the
brackets and uses it as an address. For the address to be correct, the
low byte must be first and the high byte must come immediately after.
Then the value in the Y register is added to the address. This forms the
final address to load from. Both variables must also be in the first 256
bytes of RAM, called &#8220;<strong>Zero Page</strong>&#8221;, and the X register cannot be
used with this addressing mode.</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>  <span class="kp">.rsset</span> <span class="mh">$0000</span>       <span class="c1">; put pointers in zero page</span>
<span class="n">pointerLo</span>  <span class="kp">.rs</span> <span class="mi">1</span>   <span class="c1">; pointer variables are declared in RAM</span>
<span class="n">pointerHi</span>  <span class="kp">.rs</span> <span class="mi">1</span>   <span class="c1">; low byte first, high byte immediately after</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="p">#</span><span class="mh">$D0</span>
<span class="k">STA</span> <span class="n">pointerHi</span>
<span class="k">LDA</span> <span class="p">#</span><span class="mh">$12</span>
<span class="k">STA</span> <span class="n">pointerLo</span>       <span class="c1">; pointer now says $D012</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>     <span class="k">LDY</span> <span class="p">#</span><span class="mh">$00</span>            <span class="c1">; no offset from Y</span>
     <span class="k">LDA</span> <span class="p">[</span><span class="n">pointerLo</span><span class="p">],</span> <span class="n">y</span>  <span class="c1">; load data from the address pointed to by the 16 bit pointer variable plus the value in the Y register</span>

<span class="n">That</span> <span class="n">last</span> <span class="n">line</span> <span class="n">is</span> <span class="n">the</span> <span class="n">same</span> <span class="n">as</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="mh">$D012</span><span class="p">,</span> <span class="n">y</span>
</pre></div>
</div>
<p>Because we kept Y = 0, that is the same as</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="mh">$D012</span>
</pre></div>
</div>
<dl class="docutils">
<dt>** Copy Loops **</dt>
<dd>Now using your 16 bit math the pointer address can be incremented.</dd>
</dl>
<p>Instead of being limited to 256 background tiles like when using the x
offset, the whole background can be copied in one loop. First the
address of the background data is put into the pointer variable. The
high and low bytes of the address are each copied individually. Then the
number of tiles to copy is put into the loop counter, which will count
down to 0. Each time through the loop one byte will be copied, the 16
bit pointer address will be incremented, and the 16 bit loop counter
will be decremented. The Y offset is always kept at 0, because the
pointer always points to the correct byte. When the loop counter reaches
0 everything is done.</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="p">#</span><span class="n">LOW</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>
<span class="k">STA</span> <span class="n">pointerLo</span>       <span class="c1">; put the low byte of the address of background into pointer</span>
<span class="k">LDA</span> <span class="p">#</span><span class="n">HIGH</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>
<span class="k">STA</span> <span class="n">pointerHi</span>       <span class="c1">; put the high byte of the address into pointer</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">sta</span> <span class="n">counterLo</span>       <span class="c1">; put the loop counter into 16 bit variable</span>
<span class="k">LDA</span> <span class="p">#</span><span class="mh">$04</span>
<span class="k">sta</span> <span class="n">counterHi</span>       <span class="c1">; count = $0400 = 1KB, the whole screen at once including attributes</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>  <span class="k">LDY</span> <span class="p">#</span><span class="mh">$00</span>            <span class="c1">; put y to 0 and don&#39;t change it</span>
<span class="nl">LoadBackgroundLoop:</span>
  <span class="k">LDA</span> <span class="p">[</span><span class="n">pointerLo</span><span class="p">],</span> <span class="n">y</span>
  <span class="k">STA</span> <span class="mh">$2007</span>           <span class="c1">; copy one background byte</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="n">pointerLo</span>
<span class="k">CLC</span>
<span class="k">ADC</span> <span class="p">#</span><span class="mh">$01</span>
<span class="k">STA</span> <span class="n">pointerLo</span>
<span class="k">LDA</span> <span class="n">pointerHi</span>
<span class="k">ADC</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">STA</span> <span class="n">pointerHi</span>       <span class="c1">; increment the pointer to the next byte</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="n">counterLo</span>
<span class="k">SEC</span>
<span class="k">SBC</span> <span class="p">#</span><span class="mh">$01</span>
<span class="k">STA</span> <span class="n">counterLo</span>
<span class="k">LDA</span> <span class="n">counterHi</span>
<span class="k">SBC</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">STA</span> <span class="n">counterHi</span>       <span class="c1">; decrement the loop counter</span>
</pre></div>
</div>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="n">counterLo</span>
<span class="k">CMP</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">BNE</span> <span class="n">LoadBackgroundLoop</span>
<span class="k">LDA</span> <span class="n">counterHi</span>
<span class="k">CMP</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">BNE</span> <span class="n">LoadBackgroundLoop</span>  <span class="c1">; if the loop counter isn&#39;t 0000, keep copying</span>
</pre></div>
</div>
<dl class="docutils">
<dt>That is a lot of code to copy just one byte!</dt>
<dd><strong>Nested Loops</strong>
To avoid using so much code, we can use both the X and Y registers as</dd>
</dl>
<p>loop counters. By putting one loop inside another loop we create a
&#8220;nested loop&#8221;. First the inside loop counts all the way up. Then the
outside loop counts up once, and the inside loop counts all the way
again. Normally using only X or Y would only give a maximum of 256 times
through a loop like we have previously done. With nested loops using
both X and Y the maximum is the inside counter multiplied by the outside
counter, or 256*256 = 65536.</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>  <span class="k">LDX</span> <span class="p">#</span><span class="mh">$00</span>
  <span class="k">LDY</span> <span class="p">#</span><span class="mh">$00</span>
<span class="nl">OutsideLoop:</span>

<span class="nl">InsideLoop:</span>
  <span class="c1">;</span>
  <span class="c1">; this section runs 256 x 256 times</span>
  <span class="c1">;</span>

  <span class="k">INY</span>                 <span class="c1">; inside loop counter</span>
  <span class="k">CPY</span> <span class="p">#</span><span class="mh">$00</span>
  <span class="k">BNE</span> <span class="n">InsideLoop</span>      <span class="c1">; run the inside loop 256 times before continuing down</span>

  <span class="k">INX</span>
  <span class="k">CPX</span> <span class="p">#</span><span class="mh">$00</span>
  <span class="k">BNE</span> <span class="n">OutsideLoop</span>     <span class="c1">; run the outside loop 256 times before continuing down</span>
</pre></div>
</div>
<div></div><p>First the Inside Loop runs and Y will count from 0 to 256. When that
finishes X will count 0 to 1, and branch back to the beginning of the
loops. Then the Inside Loop runs again, Y 0 -&gt; 256. X now goes 1 -&gt; 2
and the process continues. Everything ends when both X and Y have each
counted to 256.</p>
<blockquote>
<div>When we are using nested loops to copy entire backgrounds we want 256 x</div></blockquote>
<p>4 = 1KB. The Y code from above can be unchanged, but the X code is
changed to CPX #$04.</p>
<blockquote>
<div>Because we are changing the Y register our previous pointer copying</div></blockquote>
<p>code also needs to be modified. Instead of incrementing the pointer
every time, the incrementing Y register is doing the same thing. The low
byte of the pointer will be kept at 0. This means your background data
needs to be aligned to where the low byte of the address is $00. However
the high byte of the pointer still needs to change. By always making the
inside loop count 256 times, that will end at the same time that the
high byte needs to change. This time 16 bit math isn&#8217;t needed because
only the high byte is incremented.</p>
<blockquote>
<div>No loop counter is used because X and Y are used instead. If you cannot</div></blockquote>
<p>align your data so the low byte of the address is $00, you will have to
use the CopyLoop above.</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>     <span class="k">LDA</span> <span class="p">#</span><span class="mh">$00</span>
     <span class="k">STA</span> <span class="n">pointerLo</span>       <span class="c1">; put the low byte of the address of background into pointer</span>
     <span class="k">LDA</span> <span class="p">#</span><span class="n">HIGH</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>
     <span class="k">STA</span> <span class="n">pointerHi</span>       <span class="c1">; put the high byte of the address into pointer</span>

     <span class="k">LDX</span> <span class="p">#</span><span class="mh">$00</span>            <span class="c1">; start at pointer + 0</span>
     <span class="k">LDY</span> <span class="p">#</span><span class="mh">$00</span>
   <span class="nl">OutsideLoop:</span>

   <span class="nl">InsideLoop:</span>
     <span class="k">LDA</span> <span class="p">[</span><span class="n">pointerLo</span><span class="p">],</span> <span class="n">y</span>  <span class="c1">; copy one background byte from address in pointer plus Y</span>
     <span class="k">STA</span> <span class="mh">$2007</span>           <span class="c1">; this runs 256 * 4 times</span>

     <span class="k">INY</span>                 <span class="c1">; inside loop counter</span>
     <span class="k">CPY</span> <span class="p">#</span><span class="mh">$00</span>
     <span class="k">BNE</span> <span class="n">InsideLoop</span>      <span class="c1">; run the inside loop 256 times before continuing down</span>

     <span class="k">INC</span> <span class="n">pointerHi</span>       <span class="c1">; low byte went 0 to 256, so high byte needs to be changed now</span>

     <span class="k">INX</span>
     <span class="k">CPX</span> <span class="p">#</span><span class="mh">$04</span>
     <span class="k">BNE</span> <span class="n">OutsideLoop</span>     <span class="c1">; run the outside loop 256 times before continuing down</span>

<span class="o">**</span><span class="n">Putting</span> <span class="n">It</span> <span class="n">All</span> <span class="n">Together</span><span class="o">**</span>
<span class="n">Download</span> <span class="k">and</span> <span class="n">unzip</span> <span class="n">the</span>
</pre></div>
</div>
<p><a class="reference external" href="http://www.nespowerpak.com/nesasm/background3.zip">background3.zip</a>
sample files. All the code is in the background.asm file. Make sure that
file, mario.chr, and background.bat is in the same folder as NESASM,
then double click on background.bat. That will run NESASM and should
produce background3.nes. Run that NES file in FCEUXD SP to see the full
background.</p>
<blockquote>
<div>The new nested loop is used to copy a whole background to the screen</div></blockquote>
<p>instead of only 128 bytes. &nbsp;The background is aligned using the .org
directive so the low address byte is $00. &nbsp;The attributes are also
placed directly after the background data so it is are copied at the
same time.</p>
<div></div><div><p>Your task is to separate out the code that sets the pointer variables
from the code that copies the loop. That way you can have multiple
backgrounds that use different pointer loading code, but the same copy
code.</p>
<blockquote>
<div>If you are using a different assembler, the Indirect Indexed mode may</div></blockquote>
<p>use () instead of []. The LOW() and HIGH() syntax may also be different.</p>
</div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="subroutines.html"
                        title="previous chapter">7. subroutines, game layout, starting Pong</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="numbers.html"
                        title="next chapter">&lt;no title&gt;</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/nerdynights/bitmath.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="numbers.html" title="&lt;no title&gt;"
             >next</a> |</li>
        <li class="right" >
          <a href="subroutines.html" title="7. subroutines, game layout, starting Pong"
             >previous</a> |</li>
        <li><a href="../index.html">Nerdy Nights 1.0.0 documentation</a> &raquo;</li>
          <li><a href="../nerdynights.html" >Nerdy Nights</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2017, bunnyboy, MetalSlime, Taywee.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>