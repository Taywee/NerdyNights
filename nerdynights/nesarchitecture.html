<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>2. NES Architecture Overview &#8212; Nerdy Nights 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. 6502 ASM, first app" href="asmfirstapp.html" />
    <link rel="prev" title="1. Number Systems" href="numbersystems.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="asmfirstapp.html" title="3. 6502 ASM, first app"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="numbersystems.html" title="1. Number Systems"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Nerdy Nights 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../nerdynights.html" accesskey="U">Nerdy Nights</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="nes-architecture-overview">
<h1>2. NES Architecture Overview<a class="headerlink" href="#nes-architecture-overview" title="Permalink to this headline">¶</a></h1>
<div class="admonition-this-week admonition">
<p class="first admonition-title">This Week</p>
<p class="last">general overview of the NES architecture with the major components covered.
All general purpose computers are arranged the same way with a place to
store code (ROM), a place to store variables (RAM), and a processor to run
code (CPU). The NES also adds another processor to generate the graphics
(PPU) and a section of the CPU to generate audio (APU). Everything here is
very general and will have more details than you want in the next few
weeks.</p>
</div>
<dl class="docutils">
<dt>KB</dt>
<dd>Memory size is listed in KiloBytes or KB. 1KB = 1024 bytes.  Everything is
powers of 2, so 2^10 = 1024 is used instead of 1000. If the capitalization
is different, the meaning can change. Kb is Kilobits.  Divide Kb by 8 to
get KB, because 1 byte = 8 bits.</dd>
<dt>ROM</dt>
<dd>Read Only Memory, holds data that cannot be changed. This is where the game
code or graphics is stored on the cart.</dd>
<dt>RAM</dt>
<dd>Random Access Memory, holds data that can be read and written.  When power
is removed, the chip is erased. A battery can be used to keep power and
data valid.</dd>
<dt>PRG</dt>
<dd>Program memory, the code for the game</dd>
<dt>CHR</dt>
<dd>Character memory, the data for graphics</dd>
<dt>CPU</dt>
<dd>Central Processing Unit, the main processor chip</dd>
<dt>PPU</dt>
<dd>Picture Processing Unit, the graphics chip</dd>
<dt>APU</dt>
<dd>Audio Processing Unit, the sound chip inside the CPU*</dd>
</dl>
<div class="section" id="system-overview">
<h2>2.1. System Overview<a class="headerlink" href="#system-overview" title="Permalink to this headline">¶</a></h2>
<p>The NES includes a custom 6502 based CPU with the APU and controller handling
inside one chip, and a PPU that displays graphics in another chip. Your code
instructions run on the CPU and sends out commands to the APU and PPU. The NOAC
(NES On A Chip) clones like the Yobo and NEX put all of these parts onto one
chip.</p>
<p><img alt="nesarchitecture" src="../_images/nesarchitecture.png" /></p>
<p><img alt="nesboard" src="../_images/nesboard.png" /></p>
<p>There is only 2KB of RAM connected to the CPU for storing variables, and 2KB of
RAM connected to the PPU for holding two TV screens of background graphics.
Some carts add extra CPU RAM, called Work RAM or WRAM. If a cart needs to store
saved games, this WRAM will have a battery attached to make sure it isn&#8217;t
erased. A few carts add extra PPU RAM to hold four screens of background
graphics at once. This is not common. The rest of this tutorial will not use
WRAM or four screen RAM.</p>
<p>Each cart includes at least three chips. One holds the program code (PRG),
another holds the character graphics (CHR), and the last is the lockout. The
graphics chip can be RAM instead of ROM, which means the game code would copy
graphics from the PRG ROM chip to the CHR RAM. PRG is always a ROM chip.</p>
<div class="section" id="lockout-chip">
<h3>2.1.1. Lockout Chip<a class="headerlink" href="#lockout-chip" title="Permalink to this headline">¶</a></h3>
<p>Inside the NES and the cart are also two lockout chips. The lockout chip
controls resetting the console. First the NES lockout sends out a stream ID,
0-15. The cart lockout records this number. Then both lockout chips run a
complex equation using that number and send the results to each other. Both
chips know what the other is supposed to send so they both know when something
is wrong. If that happens the system enters the continuous reseting loop. This
is the screen flashing you see with a dirty cart.</p>
<p>When you cut pin 4 of the NES lockout chip, you are making it think it is
inside the cart. It sits there waiting for the ID from the NES which never
happens, so the system is never reset. If you were to completely remove the NES
lockout chip the system would not work because it controls the reset button.</p>
<p>Most lockout defeaters used by the unlicensed game companies used large voltage
spikes sent from the cart to the NES lockout. When timed right those would
crash the NES lockout, preventing it from resetting the system. Nintendo slowly
added protection against those on the NES board.  Next time you open your NES,
check the board for the revision number.  Right in the middle it will say
NES-CPU- then a number. That number is the revision. If you have 05 it is an
early one. 07 and 09 added some lockout protection. 11 was the last version
with the most lockout protection. Almost all unlicensed carts that use lockout
defeaters will not work on a NES-CPU-11 system.</p>
</div>
<div class="section" id="cpu-overview">
<h3>2.1.2. CPU Overview<a class="headerlink" href="#cpu-overview" title="Permalink to this headline">¶</a></h3>
<p>The NES CPU is a modified 6502, an 8 bit data processor similar to the Apple 2,
Atari 2600, C64, and many other systems. By the time the Famicom was created it
was underpowered for a computer but great for a game system.</p>
<p>The CPU has a 16 bit address bus which can access up to 64KB of memory.  2^16 =
65536, or 64KB. Included in that memory space is the 2KB of CPU RAM, ports to
access PPU/APU/controllers, WRAM (if on the cart), and 32KB for PRG ROM. The 16
bit addresses are written in hex, so they become 4 digits starting with a $
symbol. For example the internal RAM is at $0000-0800. $0800 = 2048 or 2KB.
32KB quickly became too small for games, which is why memory mappers were used.
Those mappers can swap in different banks of PRG code or CHR graphics. Mappers
like the MMC3 allowed up to 512KB of PRG, and 256KB of CHR. There is no limit
to the memory size if you create a new mapper chip, but 128KB PRG and 64KB CHR
was the most common size.</p>
<p><img alt="cpumemmap" src="../_images/cpumemmap.png" /></p>
</div>
<div class="section" id="ppu-overview">
<h3>2.1.3. PPU Overview<a class="headerlink" href="#ppu-overview" title="Permalink to this headline">¶</a></h3>
<p>The NES PPU is a custom chip that does all the graphics display. It includes
internal RAM for sprites and the color palette. There is RAM on the NES board
that holds the background, and all actual graphics are fetched from the cart
CHR memory.</p>
<p>Your program does not run on the PPU, the PPU always goes through the same
display order. You only set some options like colors and scrolling.  The PPU
processes one TV scanline at a time. First the sprites are fetched from the
cart CHR memory. If there are more than 8 sprites on the scanline the rest are
ignored. This is why some games like Super Dodge Ball will blink when there is
lots happening on screen. After the sprites the background is fetched from CHR
memory. When all the scanlines are done there is a period when no graphics are
sent out. This is called VBlank and is the only time graphics updates can be
done. PAL has a longer VBlank time (when the TV cathode ray gun is going back
to the top of the screen) which allows more time for graphics updates. Some PAL
games and demos do not run on NTSC systems because of this difference in VBlank
time. Both the NTSC and PAL systems have a resolution of 256x240 pixels, but
the top and bottom 8 rows are typically cut off by the NTSC TV resulting in
256x224. TV variations will cut off an additional 0-8 rows, so you should allow
for a border before drawing important information.</p>
<p>NTSC runs at 60Hz and PAL runs at 50Hz. Running an NTSC game on a PAL system
will be slower because of this timing difference. Sounds will also be slower.</p>
<p><img alt="ppumemmap" src="../_images/ppumemmap.png" /></p>
</div>
</div>
<div class="section" id="graphics-system-overview">
<h2>2.2. Graphics System Overview<a class="headerlink" href="#graphics-system-overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tiles">
<h3>2.2.1. Tiles<a class="headerlink" href="#tiles" title="Permalink to this headline">¶</a></h3>
<p>All graphics are made up of 8x8 pixel tiles. Large characters like Mario are
made from multiple 8x8 tiles. All the backgrounds are also made from these
tiles. The tile system means less memory is needed (was expensive at the time)
but also means that things like bitmap pictures and 3d graphics aren&#8217;t really
possible. To see all the tiles in a game, download <a class="reference external" href="http://www.zophar.net/utilities/download/TileMolester_015a_bin.zip">Tile Molester</a> and
open up your .NES file. Scroll down until you see graphics that don&#8217;t look like
static. You can see that small tiles are arranged by the game to make large
images.</p>
</div>
<div class="section" id="sprites">
<h3>2.2.2. Sprites<a class="headerlink" href="#sprites" title="Permalink to this headline">¶</a></h3>
<p>The PPU has enough memory for 64 sprites, or things that move around on screen
like Mario. Only 8 sprites per scanline are allowed, any more than that will be
ignored. This is where the flickering comes from in some games when there are
too many objects on screen.</p>
</div>
<div class="section" id="background">
<h3>2.2.3. Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h3>
<p>This is the landscape graphics, which scrolls all at once. The sprites can
either be displayed in front or behind the background. The screen is big enough
for 32x30 background tiles, and there is enough internal RAM to hold 2 screens.
When games scroll the background graphics are updated off screen before they
are scrolled on screen.</p>
</div>
<div class="section" id="pattern-tables">
<h3>2.2.4. Pattern Tables<a class="headerlink" href="#pattern-tables" title="Permalink to this headline">¶</a></h3>
<p>These are where the actual tile data is stored. It is either ROM or RAM on the
cart. Each pattern table holds 256 tiles. One table is used for backgrounds,
and the other for sprites. All graphics currently on screen must be in these
tables.</p>
</div>
<div class="section" id="attribute-tables">
<h3>2.2.5. Attribute Tables<a class="headerlink" href="#attribute-tables" title="Permalink to this headline">¶</a></h3>
<p>These tables set the color information in 2x2 tile sections. This means that a
16x16 pixel area can only have 4 different colors selected from the palette.</p>
</div>
<div class="section" id="palettes">
<h3>2.2.6. Palettes<a class="headerlink" href="#palettes" title="Permalink to this headline">¶</a></h3>
<p>These two areas hold the color information, one for the background and one for
sprites. Each palette has 16 colors.</p>
<p>To display a tile on screen, the pixel color index is taken from the Pattern
Table and the Attribute Table. That index is then looked up in the Palette to
get the actual color.</p>
<p><img alt="pputile" src="../_images/pputile.png" /></p>
<p>To see all the graphics, download the <a class="reference external" href="http://www.the-interweb.com/serendipity/exit.php?url_id=627&amp;entry_id=90">FCEUXD SP emulator</a>.
Open up your .NES game and choose PPU Viewer from the Tools menu. This will
show you all the active background tiles, all the active sprite tiles, and the
color palettes. Then choose Name Table Viewer from the Tools menu. This will
show you the backgrounds as they will appear on screen. If you choose a game
that scrolls like SMB you can see the off screen background sections being
updated.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">2. NES Architecture Overview</a><ul>
<li><a class="reference internal" href="#system-overview">2.1. System Overview</a><ul>
<li><a class="reference internal" href="#lockout-chip">2.1.1. Lockout Chip</a></li>
<li><a class="reference internal" href="#cpu-overview">2.1.2. CPU Overview</a></li>
<li><a class="reference internal" href="#ppu-overview">2.1.3. PPU Overview</a></li>
</ul>
</li>
<li><a class="reference internal" href="#graphics-system-overview">2.2. Graphics System Overview</a><ul>
<li><a class="reference internal" href="#tiles">2.2.1. Tiles</a></li>
<li><a class="reference internal" href="#sprites">2.2.2. Sprites</a></li>
<li><a class="reference internal" href="#background">2.2.3. Background</a></li>
<li><a class="reference internal" href="#pattern-tables">2.2.4. Pattern Tables</a></li>
<li><a class="reference internal" href="#attribute-tables">2.2.5. Attribute Tables</a></li>
<li><a class="reference internal" href="#palettes">2.2.6. Palettes</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="numbersystems.html"
                        title="previous chapter">1. Number Systems</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="asmfirstapp.html"
                        title="next chapter">3. 6502 ASM, first app</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/nerdynights/nesarchitecture.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="asmfirstapp.html" title="3. 6502 ASM, first app"
             >next</a> |</li>
        <li class="right" >
          <a href="numbersystems.html" title="1. Number Systems"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Nerdy Nights 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../nerdynights.html" >Nerdy Nights</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, bunnyboy, MetalSlime, Taywee.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>