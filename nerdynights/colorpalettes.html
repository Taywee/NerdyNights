<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>4. Color Palettes, Sprites, second app &mdash; Nerdy Nights 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Nerdy Nights 1.0.0 documentation" href="../index.html" />
    <link rel="up" title="Nerdy Nights" href="../nerdynights.html" />
    <link rel="next" title="5. multiple sprites, reading controllers, more instructions" href="multiplesprites.html" />
    <link rel="prev" title="3. 6502 ASM, first app" href="asmfirstapp.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="multiplesprites.html" title="5. multiple sprites, reading controllers, more instructions"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="asmfirstapp.html" title="3. 6502 ASM, first app"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Nerdy Nights 1.0.0 documentation</a> &raquo;</li>
          <li><a href="../nerdynights.html" accesskey="U">Nerdy Nights</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="color-palettes-sprites-second-app">
<h1>4. Color Palettes, Sprites, second app<a class="headerlink" href="#color-palettes-sprites-second-app" title="Permalink to this headline">¶</a></h1>
<div class="admonition-this-week admonition">
<p class="first admonition-title">This Week</p>
<p class="last">now that you can make and run a program, time to put
something on screen!</p>
</div>
<div class="section" id="palettes">
<h2>4.1. Palettes<a class="headerlink" href="#palettes" title="Permalink to this headline">¶</a></h2>
<p>Before putting any graphics on screen, you first need to set the color
palette. There are two separate palettes, each 16 bytes. One palette is
used for the background, and the other for sprites. The byte in the
palette corresponds to one of the 64 base colors the NES can display.
$0D is a bad color and should not be used. These colors are not exact
and will look different on emulators and TVs.</p>
<p><img alt="palette" src="../_images/4924FAF3-9FC9-CED2-8403873F9EA75342.png" /></p>
<p>The palettes start at PPU address $3F00 and $3F10. To set this address,
PPU address port $2006 is used. This port must be written twice, once
for the high byte then for the low byte:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="mh">$2002</span>    <span class="c1">; read PPU status to reset the high/low latch to high</span>
<span class="k">LDA</span> <span class="p">#</span><span class="mh">$3F</span>
<span class="k">STA</span> <span class="mh">$2006</span>    <span class="c1">; write the high byte of $3F10 address</span>
<span class="k">LDA</span> <span class="p">#</span><span class="mh">$10</span>
<span class="k">STA</span> <span class="mh">$2006</span>    <span class="c1">; write the low byte of $3F10 address</span>
</pre></div>
</div>
<p>That code tells the PPU to set its address to $3F10. Now the PPU data
port at $2007 is ready to accept data. The first write will go to the
address you set ($3F10), then the PPU will automatically increment the
address ($3F11, $3F12, $3F13) after each read or write. You can keep
writing data and it will keep incrementing. This sets the first 4 colors
in the palette:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="p">#</span><span class="mh">$32</span>   <span class="c1">;code for light blueish</span>
<span class="k">STA</span> <span class="mh">$2007</span>  <span class="c1">;write to PPU $3F10</span>
<span class="k">LDA</span> <span class="p">#</span><span class="mh">$14</span>   <span class="c1">;code for pinkish</span>
<span class="k">STA</span> <span class="mh">$2007</span>  <span class="c1">;write to PPU $3F11</span>
<span class="k">LDA</span> <span class="p">#</span><span class="mh">$2A</span>   <span class="c1">;code for greenish</span>
<span class="k">STA</span> <span class="mh">$2007</span>  <span class="c1">;write to PPU $3F12</span>
<span class="k">LDA</span> <span class="p">#</span><span class="mh">$16</span>   <span class="c1">;code for redish</span>
<span class="k">STA</span> <span class="mh">$2007</span>  <span class="c1">;write to PPU $3F13</span>
</pre></div>
</div>
<p>You would continue to do writes to fill out the rest of the palette.
Fortunately there is a smaller way to write all that code. First you can
use the .db directive to store data bytes:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="nl">PaletteData:</span>
  <span class="kp">.db</span> <span class="mh">$0F</span><span class="p">,</span><span class="mh">$31</span><span class="p">,</span><span class="mh">$32</span><span class="p">,</span><span class="mh">$33</span><span class="p">,</span><span class="mh">$0F</span><span class="p">,</span><span class="mh">$35</span><span class="p">,</span><span class="mh">$36</span><span class="p">,</span><span class="mh">$37</span><span class="p">,</span><span class="mh">$0F</span><span class="p">,</span><span class="mh">$39</span><span class="p">,</span><span class="mh">$3A</span><span class="p">,</span><span class="mh">$3B</span><span class="p">,</span><span class="mh">$0F</span><span class="p">,</span><span class="mh">$3D</span><span class="p">,</span><span class="mh">$3E</span><span class="p">,</span><span class="mh">$0F</span>  <span class="c1">;background palette data</span>
  <span class="kp">.db</span> <span class="mh">$0F</span><span class="p">,</span><span class="mh">$1C</span><span class="p">,</span><span class="mh">$15</span><span class="p">,</span><span class="mh">$14</span><span class="p">,</span><span class="mh">$0F</span><span class="p">,</span><span class="mh">$02</span><span class="p">,</span><span class="mh">$38</span><span class="p">,</span><span class="mh">$3C</span><span class="p">,</span><span class="mh">$0F</span><span class="p">,</span><span class="mh">$1C</span><span class="p">,</span><span class="mh">$15</span><span class="p">,</span><span class="mh">$14</span><span class="p">,</span><span class="mh">$0F</span><span class="p">,</span><span class="mh">$02</span><span class="p">,</span><span class="mh">$38</span><span class="p">,</span><span class="mh">$3C</span>  <span class="c1">;sprite palette data</span>
</pre></div>
</div>
<p>Then a loop is used to copy those bytes to the palette in the PPU. The X
register is used as an index into the palette, and used to count how
many times the loop has repeated. You want to copy both palettes at once
which is 32 bytes, so the loop starts at 0 and counts up to 32:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span>  <span class="k">LDX</span> <span class="p">#</span><span class="mh">$00</span>                <span class="c1">; start out at 0</span>
<span class="nl">LoadPalettesLoop:</span>
  <span class="k">LDA</span> <span class="n">PaletteData</span><span class="p">,</span> <span class="n">x</span>      <span class="c1">; load data from address (PaletteData + the value in x)</span>
                          <span class="c1">; 1st time through loop it will load PaletteData+0</span>
                          <span class="c1">; 2nd time through loop it will load PaletteData+1</span>
                          <span class="c1">; 3rd time through loop it will load PaletteData+2</span>
                          <span class="c1">; etc</span>
  <span class="k">STA</span> <span class="mh">$2007</span>               <span class="c1">; write to PPU</span>
  <span class="k">INX</span>                     <span class="c1">; X = X + 1</span>
  <span class="k">CPX</span> <span class="p">#</span><span class="mh">$20</span>                <span class="c1">; Compare X to hex $20, decimal 32</span>
  <span class="k">BNE</span> <span class="n">LoadPalettesLoop</span>    <span class="c1">; Branch to LoadPalettesLoop if compare was Not Equal to zero</span>
                          <span class="c1">; if compare was equal to 32, keep going down</span>
</pre></div>
</div>
<p>Once that code finishes, the full color palette is ready. One byte or
the whole thing can be changed while your program is running.</p>
</div>
<div class="section" id="sprites">
<h2>4.2. Sprites<a class="headerlink" href="#sprites" title="Permalink to this headline">¶</a></h2>
<p>Anything that moves separately from the background will be made of
sprites. A sprite is just an 8x8 pixel tile that the PPU renders
anywhere on the screen. Generally objects are made from multiple sprites
next to each other. Examples would be Mario and any of the enemies like
Goombas and Bowser. The PPU has enough internal memory for 64 sprites.
This memory is separate from all other video memory and cannot be
expanded.</p>
<div class="section" id="sprite-dma">
<h3>4.2.1. Sprite DMA<a class="headerlink" href="#sprite-dma" title="Permalink to this headline">¶</a></h3>
<p>The fastest and easiest way to transfer your sprites to the sprite
memory is using DMA (direct memory access). This just means a block of
RAM is copied from CPU memory to the PPU sprite memory. The on board RAM
space from $0200-02FF is usually used for this purpose. To start the
transfer, two bytes need to be written to the PPU ports:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">STA</span> <span class="mh">$2003</span>  <span class="c1">; set the low byte (00) of the RAM address</span>
<span class="k">LDA</span> <span class="p">#</span><span class="mh">$02</span>
<span class="k">STA</span> <span class="mh">$4014</span>  <span class="c1">; set the high byte (02) of the RAM address, start the transfer</span>
</pre></div>
</div>
<p>Once the second write is done the DMA transfer will start automatically.
All data for the 64 sprites will be copied. Like all graphics updates,
this needs to be done at the beginning of the VBlank period, so it will
go in the NMI section of your code.</p>
</div>
<div class="section" id="sprite-data">
<h3>4.2.2. Sprite Data<a class="headerlink" href="#sprite-data" title="Permalink to this headline">¶</a></h3>
<p>Each sprite needs 4 bytes of data for its position and tile information
in this order:</p>
<ol class="arabic">
<li><p class="first">Y Position - vertical position of the sprite on screen. $00 is the top of
the screen. Anything above $EF is off the bottom of the screen.</p>
</li>
<li><p class="first">Tile Number - this is the tile number (0 to 256) for the graphic to be taken
from a Pattern Table.</p>
</li>
<li><p class="first">Attributes - this byte holds color and displaying information:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="mi">76543210</span>
<span class="o">|||</span>   <span class="o">||</span>
<span class="o">|||</span>   <span class="o">++-</span> <span class="n">Color</span> <span class="n">Palette</span> <span class="n">of</span> <span class="n">sprite.</span>  <span class="n">Choose</span> <span class="n">which</span> <span class="n">set</span> <span class="n">of</span> <span class="mi">4</span> <span class="n">from</span> <span class="n">the</span> <span class="mi">16</span> <span class="n">colors</span> <span class="n">to</span> <span class="n">use</span>
<span class="o">|||</span>
<span class="o">||+------</span> <span class="n">Priority</span> <span class="p">(</span><span class="mi">0</span><span class="p">:</span> <span class="n">in</span> <span class="n">front</span> <span class="n">of</span> <span class="n">background</span><span class="c1">; 1: behind background)</span>
<span class="o">|+-------</span> <span class="n">Flip</span> <span class="n">sprite</span> <span class="n">horizontally</span>
<span class="o">+--------</span> <span class="n">Flip</span> <span class="n">sprite</span> <span class="n">vertically</span>
</pre></div>
</div>
</li>
<li><p class="first">X Position - horizontal position on the screen. $00 is the left side,
anything above $F9 is off screen.</p>
</li>
</ol>
<p>Those 4 bytes repeat 64 times (one set per sprite) to fill the 256 bytes of
sprite memory. If you want to edit sprite 0, you change bytes $0200-0203.
Sprite 1 is $0204-0207, sprite 2 is $0208-020B, etc</p>
</div>
<div class="section" id="turning-nmi-sprites-on">
<h3>4.2.3. Turning NMI/Sprites On<a class="headerlink" href="#turning-nmi-sprites-on" title="Permalink to this headline">¶</a></h3>
<p>The PPU port $2001 is used again to enable sprites. Setting bit 4 to 1
will make them appear. NMI also needs to be turned on, so the Sprite DMA
will run and the sprites will be copied every frame. This is done with
the PPU port $2000. The Pattern Table 0 is also selected to choose
sprites from. Background will come from Pattern Table 1 when that is
added later:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="n">PPUCTRL</span> <span class="p">(</span><span class="mh">$2000</span><span class="p">)</span>
<span class="mi">76543210</span>
<span class="o">|</span> <span class="o">||||||</span>
<span class="o">|</span> <span class="o">||||++-</span> <span class="n">Base</span> <span class="n">nametable</span> <span class="n">address</span>
<span class="o">|</span> <span class="o">||||</span>    <span class="p">(</span><span class="mi">0</span> <span class="o">=</span> <span class="mh">$2000</span><span class="c1">; 1 = $2400; 2 = $2800; 3 = $2C00)</span>
<span class="o">|</span> <span class="o">|||+---</span> <span class="n">VRAM</span> <span class="n">address</span> <span class="n">increment</span> <span class="n">per</span> <span class="n">CPU</span> <span class="n">read</span><span class="o">/</span><span class="n">write</span> <span class="n">of</span> <span class="n">PPUDATA</span>
<span class="o">|</span> <span class="o">|||</span>     <span class="p">(</span><span class="mi">0</span><span class="p">:</span> <span class="n">increment</span> <span class="n">by</span> <span class="mi">1</span><span class="p">,</span> <span class="n">going</span> <span class="n">across</span><span class="c1">; 1: increment by 32, going down)</span>
<span class="o">|</span> <span class="o">||+----</span> <span class="n">Sprite</span> <span class="n">pattern</span> <span class="n">table</span> <span class="n">address</span> <span class="n">for</span> <span class="mi">8</span><span class="n">x8</span> <span class="n">sprites</span> <span class="p">(</span><span class="mi">0</span><span class="p">:</span> <span class="mh">$0000</span><span class="c1">; 1: $1000)</span>
<span class="o">|</span> <span class="o">|+-----</span> <span class="n">Background</span> <span class="n">pattern</span> <span class="n">table</span> <span class="n">address</span> <span class="p">(</span><span class="mi">0</span><span class="p">:</span> <span class="mh">$0000</span><span class="c1">; 1: $1000)</span>
<span class="o">|</span> <span class="o">+------</span> <span class="n">Sprite</span> <span class="n">size</span> <span class="p">(</span><span class="mi">0</span><span class="p">:</span> <span class="mi">8</span><span class="n">x8</span><span class="c1">; 1: 8x16)</span>
<span class="o">|</span>
<span class="o">+--------</span> <span class="n">Generate</span> <span class="n">an</span> <span class="n">NMI</span> <span class="n">at</span> <span class="n">the</span> <span class="n">start</span> <span class="n">of</span> <span class="n">the</span>
          <span class="n">vertical</span> <span class="n">blanking</span> <span class="n">interval</span> <span class="n">vblank</span> <span class="p">(</span><span class="mi">0</span><span class="p">:</span> <span class="n">off</span><span class="c1">; 1: on)</span>
</pre></div>
</div>
<p>And the new code to set up the sprite data:</p>
<div class="highlight-ca65"><div class="highlight"><pre><span></span><span class="k">LDA</span> <span class="p">#</span><span class="mh">$80</span>
<span class="k">STA</span> <span class="mh">$0200</span>        <span class="c1">;put sprite 0 in center ($80) of screen vertically</span>
<span class="k">STA</span> <span class="mh">$0203</span>        <span class="c1">;put sprite 0 in center ($80) of screen horizontally</span>
<span class="k">LDA</span> <span class="p">#</span><span class="mh">$00</span>
<span class="k">STA</span> <span class="mh">$0201</span>        <span class="c1">;tile number = 0</span>
<span class="k">STA</span> <span class="mh">$0202</span>        <span class="c1">;color palette = 0, no flipping</span>

<span class="k">LDA</span> <span class="p">#</span><span class="mb">%10000000</span>   <span class="c1">; enable NMI, sprites from Pattern Table 0</span>
<span class="k">STA</span> <span class="mh">$2000</span>

<span class="k">LDA</span> <span class="p">#</span><span class="mb">%00010000</span>   <span class="c1">; no intensify (black background), enable sprites</span>
<span class="k">STA</span> <span class="mh">$2001</span>
</pre></div>
</div>
</div>
<div class="section" id="putting-it-all-together">
<h3>4.2.4. Putting It All Together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this headline">¶</a></h3>
<p>Download and unzip the <a class="reference download internal" href="../_downloads/sprites.zip"><tt class="xref download docutils literal"><span class="pre">sprites.zip</span></tt></a> sample files. All the
code above is in the sprites.asm file. Make sure sprites.asm, mario.chr, and
sprites.bat are all in the same folder as NESASM3, then double click
sprites.bat. That will run NESASM3 and should produce the sprites.nes file. Run
that NES file in FCEUXD SP to see your sprite! Tile number 0 is the back of
Mario&#8217;s head and hat, can you see it? Edit sprites.asm to change the sprite
position (0 to 255), or to change the color palette for the sprite (0 to 3).
You can choose the PPU viewer in FCEUXD SP to see both Pattern Tables, and both
Palettes.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4. Color Palettes, Sprites, second app</a><ul>
<li><a class="reference internal" href="#palettes">4.1. Palettes</a></li>
<li><a class="reference internal" href="#sprites">4.2. Sprites</a><ul>
<li><a class="reference internal" href="#sprite-dma">4.2.1. Sprite DMA</a></li>
<li><a class="reference internal" href="#sprite-data">4.2.2. Sprite Data</a></li>
<li><a class="reference internal" href="#turning-nmi-sprites-on">4.2.3. Turning NMI/Sprites On</a></li>
<li><a class="reference internal" href="#putting-it-all-together">4.2.4. Putting It All Together</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="asmfirstapp.html"
                        title="previous chapter">3. 6502 ASM, first app</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="multiplesprites.html"
                        title="next chapter">5. multiple sprites, reading controllers, more instructions</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/nerdynights/colorpalettes.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="multiplesprites.html" title="5. multiple sprites, reading controllers, more instructions"
             >next</a> |</li>
        <li class="right" >
          <a href="asmfirstapp.html" title="3. 6502 ASM, first app"
             >previous</a> |</li>
        <li><a href="../index.html">Nerdy Nights 1.0.0 documentation</a> &raquo;</li>
          <li><a href="../nerdynights.html" >Nerdy Nights</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2017, bunnyboy, MetalSlime, Taywee.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>